<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Main Street Bagel Admin</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  </head>
  <body>
    <script src="https://unpkg.com/decap-cms@^3.10.0/dist/decap-cms.js"></script>

<script>
  // 1. Path Fixer
  const fixPath = (path) => {
    if (!path) return '';
    return path.startsWith('/') ? path.substring(1) : path;
  };

  // 2. Defensive Preview Component
  const HomePreview = ({ entry }) => {
    // entry.getIn(['data']) can be null during initial load
    const data = entry.getIn(['data']) ? entry.getIn(['data']).toJS() : {};

    // Use "Optional Chaining" (?.) to prevent crashes if objects are missing
    return React.createElement('div', { 
      style: { padding: '20px', fontFamily: 'sans-serif' } 
    },
      // Hero Section
      React.createElement('section', { style: { textAlign: 'center', padding: '20px', background: '#f9f9f9' } },
        React.createElement('h1', null, data.hero?.title || 'Title Missing'),
        React.createElement('p', null, data.hero?.subtitle || ''),
        data.hero?.image && React.createElement('img', { 
          src: fixPath(data.hero.image), 
          style: { width: '100%', maxWidth: '400px' } 
        })
      ),

      // Sections List - Add a check to ensure it's an array
      Array.isArray(data.sections) && data.sections.map((s, i) => (
        React.createElement('div', { key: i, style: { marginTop: '20px' } },
          React.createElement('h3', null, s.title || 'New Section'),
          React.createElement('p', null, s.description || ''),
          s.image && React.createElement('img', { src: fixPath(s.image), style: { width: '100px' } })
        )
      )),

      // Popular Items - Ensure nested data exists
      React.createElement('h2', { style: { marginTop: '30px' } }, data.popular?.title || 'Popular Items'),
      React.createElement('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' } },
        Array.isArray(data.popular?.items) && data.popular.items.map((item, i) => (
          React.createElement('div', { key: i, style: { border: '1px solid #eee', padding: '5px' } },
            item.img && React.createElement('img', { src: fixPath(item.img), style: { width: '100%' } }),
            React.createElement('b', { style: { display: 'block' } }, item.title || 'Item Name')
          )
        ))
      )
    );
  };

  // 3. Register
  CMS.registerPreviewTemplate("homepage", HomePreview);
</script>

  </body>
</html>